import{j as e,A as t,m as s}from"./ui-vendor-090db037.js";import{f as a}from"./format-01d13a2f.js";import{r,b as l}from"./react-vendor-e826ac9a.js";import{c as n,u as i,a as o,h as d,d as c,k as u,e as m,l as p,j as x,m as g}from"./index-51f22912.js";import{M as h}from"./MapAddressModal-eea30a8e.js";import{c as y,u as v}from"./data-vendor-7193eb6f.js";import"./map-vendor-da2eca32.js";function f(e,t="start"){if(null==e)return null;if("number"==typeof e){const t=e>1e12?e:1e3*e;return Number.isFinite(t)?t:null}const s=String(e).trim();if(!s)return null;if(/^\d{10,13}$/.test(s)){const e=Number(s.length<=10?1e3*Number(s):Number(s));return Number.isFinite(e)?e:null}const a=/[T\s]\d{1,2}:\d{2}/.test(s)?s.replace(" ","T"):s+("start"===t?"T00:00:00":"T23:59:59.999"),r=new Date(a).getTime();return isNaN(r)?null:r}function b({isOpen:a,onClose:l,coupons:n,totalAmount:i,appliedCode:o,onApply:d}){const[c,u]=r.useState(""),m=Date.now(),p=r.useMemo(()=>{var e;const t=n.map(e=>{const t=f(e.startsAt,"start"),s=f(e.expiresAt,"end"),a=(null==t||t<=m)&&(null==s||m<=s),r=null!=s&&m>s,l=null!=t&&m<t,n=!(null==(o=e.isActive)||("boolean"==typeof o?o:"number"==typeof o?0!==o:"string"!=typeof o||!/^(false|0|no|off)$/i.test(o.trim())));var o;const d=!n&&!r&&!l&&a,c=function(e,t){var s;const a=Number(null!=(s=e.minOrderValue)?s:0)||0,r=Number(t)||0;return a>0&&r<a?{eligible:!1,reason:"Add ₹".concat(a-r," more to avail this offer"),addMore:a-r}:{eligible:!0}}(e,i),u=d&&c.eligible?function(e,t){const s=Number(t)||0,a=Number(e.discountValue)||0,r=null==e.maxDiscount?null:Number(e.maxDiscount)||0;if("amount"===e.discountType)return Math.max(0,Math.min(a,s));const l=a/100*s,n=null==r?l:Math.min(l,r);return Math.floor(n)}(e,i):0;return{c:e,active:d,elig:c,savings:u,expired:r,notStarted:l,inactive:n}}),s=t.filter(e=>e.active&&e.elig.eligible).sort((e,t)=>t.savings-e.savings);return{eligible:s,ineligible:t.filter(e=>!(e.active&&e.elig.eligible)),best:(null==(e=s[0])?void 0:e.c.code)||null}},[n,i,m]),x=({data:t})=>{const s="percentage"===t.c.discountType,a=s?"PERCENT OFF":"FLAT OFF",r=s?"Save ".concat(t.c.discountValue,"%").concat(t.c.maxDiscount?" up to ₹".concat(t.c.maxDiscount):""):"Get Flat ₹".concat(t.c.discountValue," off"),n=s?"Use code ".concat(t.c.code," & save ").concat(t.c.discountValue,"%").concat(t.c.maxDiscount?" (max ₹".concat(t.c.maxDiscount,")"):"").concat(t.c.minOrderValue?" on orders above ₹".concat(t.c.minOrderValue):""):"Use code ".concat(t.c.code," & get ₹").concat(t.c.discountValue," off").concat(t.c.minOrderValue?" on orders above ₹".concat(t.c.minOrderValue):""),i=!(t.active&&t.elig.eligible),c=p.best&&p.best===t.c.code;let u=o&&o===t.c.code?"APPLIED":"APPLY";return i&&(t.expired?u="EXPIRED":t.notStarted?u="SOON":t.inactive&&(u="UNAVAILABLE")),e.jsxs("div",{className:"relative overflow-hidden rounded-xl border ".concat(i?"border-gray-200 opacity-70":"border-green-200"," bg-white"),children:[e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-14 bg-gray-100 flex flex-col items-center justify-center text-[10px] tracking-wider text-gray-600",children:e.jsx("div",{className:"rotate-[-90deg] whitespace-nowrap",children:a})}),e.jsxs("div",{className:"pl-16 p-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-extrabold tracking-wide",children:t.c.code}),!t.elig.eligible&&t.elig.reason&&e.jsx("p",{className:"text-xs text-amber-700 mt-1",children:t.elig.reason}),t.elig.eligible&&e.jsxs("p",{className:"text-xs text-green-700 mt-1",children:["You save ₹",t.savings]})]}),e.jsx("button",{disabled:i,onClick:()=>{d(t.c),l()},className:"text-sm font-semibold ".concat(i?"text-gray-400 cursor-not-allowed":"text-green-700 hover:text-green-800"),children:u})]}),e.jsx("p",{className:"text-sm text-gray-800 mt-2",children:r}),e.jsx("div",{className:"my-2 border-t border-dashed"}),e.jsx("p",{className:"text-xs text-gray-600",children:n}),i&&t.expired&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Coupon expired"}),t.c.description&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:t.c.description}),c&&e.jsx("span",{className:"inline-block mt-2 text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full",children:"Best savings"})]})]})};return e.jsx(t,{children:a&&e.jsxs(s.div,{className:"fixed inset-0 z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:l}),e.jsxs(s.div,{className:"absolute inset-x-0 bottom-0 bg-gray-50 rounded-t-2xl shadow-2xl max-h-[85vh] overflow-auto",initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",stiffness:260,damping:28},children:[e.jsxs("div",{className:"p-4 border-b bg-white rounded-t-2xl",children:[e.jsx("div",{className:"h-1 w-10 bg-gray-200 rounded mx-auto mb-3"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Apply Coupon"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Your cart: ₹",i]})]}),e.jsx("button",{onClick:l,className:"text-sm text-gray-600 hover:text-gray-800",children:"Close"})]}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx("input",{value:c,onChange:e=>u(e.target.value.toUpperCase()),placeholder:"Enter coupon code",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"}),e.jsx("button",{onClick:()=>{const e=c.trim().toLowerCase(),t=p.eligible.find(t=>t.c.code.toLowerCase()===e);t&&(d(t.c),l())},className:"px-4 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700",children:"Apply"})]})]}),e.jsxs("div",{className:"p-4 space-y-3",children:[p.eligible.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600",children:"Eligible for you"}),p.eligible.map(t=>e.jsx(x,{data:t},t.c.code))]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600",children:"More offers"}),0===p.ineligible.length?e.jsx("p",{className:"text-xs text-gray-500",children:"No other offers."}):p.ineligible.map(t=>e.jsx(x,{data:t},t.c.code))]})]})]})]})})}function j(){const{user:t,isAuthenticated:s,refreshProfile:f}=n(),{items:j,totalPrice:N,clearCart:w}=i();o(j.map(e=>e.product._id));const[A,D]=r.useState(!0),{Banner:O}=d({enabled:A,mutate:!1}),C=l(),k=y(),[S,P]=r.useState(""),[T,M]=r.useState(!1),[E,V]=r.useState(!1),[F,q]=r.useState(!1),[_,I]=r.useState(!1),[U,L]=r.useState([]),{show:K}=c(),[R,Y]=r.useState(null),[B,Q]=r.useState({address:(null==t?void 0:t.address)||{houseNo:"",landmark:"",area:"",city:"Mysore",state:"Karnataka",pincode:""},latitude:(null==t?void 0:t.latitude)||0,longitude:(null==t?void 0:t.longitude)||0,phone:(null==t?void 0:t.phone)||""}),G=r.useMemo(()=>(null==t?void 0:t.latitude)&&(null==t?void 0:t.longitude)?{lat:t.latitude,lon:t.longitude}:B.latitude&&B.longitude?{lat:B.latitude,lon:B.longitude}:null,[null==t?void 0:t.latitude,null==t?void 0:t.longitude,B.latitude,B.longitude]),{data:J}=v({queryKey:["public","delivery-settings"],queryFn:async()=>{var e,t,s,a;try{const r=(await x()).data;if(!r)throw new Error("No data");return{enabled:null==(e=r.enabled)||e,deliveryFee:null!=(t=r.deliveryFee)?t:0,freeDeliveryThreshold:null!=(s=r.freeDeliveryThreshold)?s:0,minOrderSubtotal:null!=(a=r.minOrderSubtotal)?a:0,updatedAt:r.updatedAt}}catch(r){return{enabled:!0,deliveryFee:0,freeDeliveryThreshold:0,minOrderSubtotal:0}}},staleTime:6e5});r.useEffect(()=>{t&&Q(e=>({...e,address:t.address||{houseNo:"",landmark:"",area:"",city:"Mysore",state:"Karnataka",pincode:""},latitude:e.latitude&&0!==e.latitude?e.latitude:t.latitude||0,longitude:e.longitude&&0!==e.longitude?e.longitude:t.longitude||0,phone:t.phone||""}))},[t]),r.useEffect(()=>{0===j.length&&C("/cart",{replace:!0})},[j.length,C]);const{data:$=[]}=v({queryKey:["admin","coupons"],queryFn:async()=>{var e;try{const e=(await g({page:1,limit:100})).data;let t=[];Array.isArray(e)?t=e:e&&"object"==typeof e&&Array.isArray(e.data)&&(t=e.data||[]);return t.map(e=>{var t,s,a,r,l,n;const i=(null!=(s=null!=(t=e.code)?t:e.couponCode)?s:"").toString().toUpperCase();if(!i)return null;return{code:i,discountType:"percentage"===e.discountType||"amount"===e.discountType?e.discountType:"amount",discountValue:"number"==typeof e.discountValue?e.discountValue:0,minOrderValue:null!=(a=e.minOrderValue)?a:null,maxDiscount:null!=(r=e.maxDiscount)?r:null,startsAt:null!=(l=e.startsAt)?l:null,expiresAt:null!=(n=e.expiresAt)?n:null,isActive:e.isActive}}).filter(e=>!!e)}catch(t){const s=null==(e=null==t?void 0:t.response)?void 0:e.status;if(401===s||403===s)return[];throw t}},staleTime:3e5}),z=r.useMemo(()=>{if(!R)return 0;if("amount"===R.discountType)return Math.max(0,Math.min(R.discountValue,N));const e=R.discountValue/100*N,t=null==R.maxDiscount?e:Math.min(e,R.maxDiscount);return Math.floor(t)},[R,N]),X=Math.max(0,N-z),H=(()=>{const e=J;return e&&e.enabled?e.freeDeliveryThreshold>0&&X>=e.freeDeliveryThreshold?0:e.deliveryFee||0:0})(),W=Math.max(0,X+H),Z=(()=>{if(!J)return 0;const e=J.minOrderSubtotal||0;return Math.max(0,e-N)})();return 0===j.length?null:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Checkout"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Order Summary"}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6 space-y-4",children:[j.map(t=>{const s="number"==typeof t.product.g?t.product.g:0,r="number"==typeof t.product.pieces?t.product.pieces:0,l=s>0?s*t.quantity:0,n=l>0?a(l)||"".concat(l," g"):null,i=r>0?r*t.quantity:0;return e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"min-w-0 pr-2",children:[e.jsx("p",{className:"font-medium truncate",children:t.product.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",t.quantity]}),s>0&&e.jsxs("p",{className:"text-xs text-gray-600",children:["Each: ",a(s)||"".concat(s," g")," • Total: ",n]}),r>0&&e.jsxs("p",{className:"text-xs text-gray-600",children:["Each: ",r," pcs • Total: ",i," pcs"]})]}),e.jsxs("p",{className:"font-medium whitespace-nowrap",children:["₹",t.product.price*t.quantity]})]},t.product._id)}),e.jsxs("div",{className:"border-t pt-4 mt-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between font-semibold",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₹",N]})]}),R&&e.jsxs("div",{className:"flex justify-between text-green-700",children:[e.jsxs("span",{children:["Coupon (",R.code,")"]}),e.jsxs("span",{children:["-₹",z]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsx("span",{children:"Delivery Fee"}),e.jsx("span",{children:0===H?"Free":"₹".concat(H)})]}),e.jsxs("div",{className:"flex justify-between text-base",children:[e.jsx("span",{className:"font-semibold",children:"Payable"}),e.jsxs("span",{className:"font-bold",children:["₹",W]})]}),J&&J.enabled&&e.jsx("div",{className:"text-xs text-gray-600",children:J.freeDeliveryThreshold>0&&X<J.freeDeliveryThreshold?e.jsxs("p",{children:["Free delivery over ₹",J.freeDeliveryThreshold]}):null})]})]})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Delivery Details"}),S&&e.jsx("div",{className:"bg-red-100 text-red-700 p-3 rounded-lg mb-6",children:S}),e.jsxs("form",{onSubmit:async e=>{var t,a,r,l,n,i;e.preventDefault();try{M(!0),P(""),D(!1);try{globalThis.__RECONCILE_PAUSED=!0}catch(o){0}const e=String(B.phone||"").replace(/\D/g,"");if(!e||e.length<10)return P("Please enter a valid phone number."),void K("Please enter a valid phone number.",{type:"warning"});if(!B.address||[B.address.houseNo,B.address.area,B.address.landmark,B.address.city,B.address.state,B.address.pincode].every(e=>!e||0===e.trim().length))return P("Please enter your delivery address."),void K("Please enter your delivery address.",{type:"warning"});if((null==J?void 0:J.enabled)&&Z>0)return P("Add ₹".concat(Z," more to reach minimum order value.")),void K("Add ₹".concat(Z," more to reach minimum order value."),{type:"warning"});let c;if(!s)return P("Please log in to place an order."),void C("/login");try{const e=[];if(await Promise.all(j.map(async t=>{var s,a;try{const r=(await m(t.product._id)).data,l=Math.max(0,Number(null!=(a=null!=(s=null==r?void 0:r.stock)?s:t.product.stock)?a:0)),n=t.quantity;(l<=0&&n>0||n>l)&&e.push({productId:t.product._id,requested:n,available:l,name:(null==r?void 0:r.name)||t.product.name})}catch(o){}})),e.length>0){L(e);if(e.every(e=>e.available<=0)&&e.length===j.length)return P("All items appear out of stock. Please review your cart."),void K("All items appear out of stock. Please review your cart.",{type:"error"});K("".concat(e.length," item(s) may be reduced due to stock."),{type:"warning"})}}catch(o){}try{const s=(await p({...B,phone:e,paymentMode:"COD",idempotencyKey:(null==(a=null==(t=globalThis.crypto)?void 0:t.randomUUID)?void 0:a.call(t))||"".concat(Date.now(),"_").concat(Math.random()),couponCode:(null==(r=null==R?void 0:R.code)?void 0:r.trim())?R.code.trim():void 0,items:j.map(e=>({productId:e.product._id,quantity:e.quantity}))})).data||{},l=s.order||s;c=(null==l?void 0:l._id)||(null==l?void 0:l.id),await k.invalidateQueries({queryKey:["orders"]}),await k.refetchQueries({queryKey:["orders"],type:"active"}),Array.isArray(s.itemsOutOfStock)&&s.itemsOutOfStock.length>0?(L(s.itemsOutOfStock),K("".concat(s.itemsOutOfStock.length," item(s) removed due to stock."),{type:"warning"})):K("Order placed successfully",{type:"success"})}catch(d){const t=d,s=null==(l=null==t?void 0:t.response)?void 0:l.status,a=null==(n=null==t?void 0:t.response)?void 0:n.data;if("number"==typeof s){if(400===s){if("MIN_ORDER_NOT_MET"===(null==a?void 0:a.reason)){const e=Number(null!=(i=null==a?void 0:a.shortfall)?i:0);P("Add ₹".concat(e," more to reach minimum order value.")),K("Add ₹".concat(e," more to reach minimum order value."),{type:"warning"})}else{const e=(null==a?void 0:a.message)||"Cart seems empty or invalid request.";P(e),K(e,{type:"error"})}return}return 401===s?(P("Your session expired. Please log in again."),K("Your session expired. Please log in again.",{type:"error"}),void C("/login")):404===s?(P((null==a?void 0:a.message)||"User not found. Please log in again."),K("User not found. Please log in again.",{type:"error"}),void C("/login")):409===s?(P((null==a?void 0:a.message)||"All items are out of stock."),void K("All items are out of stock.",{type:"error"})):(P((null==a?void 0:a.message)||"Error creating order. Please try again."),void K((null==a?void 0:a.message)||"Error creating order. Please try again.",{type:"error"}))}const r=localStorage.getItem("sakkat_orders"),o=r?JSON.parse(r):[],u="local_".concat(Date.now()),m={id:u,items:j.map(e=>({productId:e.product._id,quantity:e.quantity,price:e.product.price})),totalPrice:N,address:B.address,latitude:B.latitude,longitude:B.longitude,phone:e,createdAt:(new Date).toISOString(),paymentMode:"COD",status:"pending"};localStorage.setItem("sakkat_orders",JSON.stringify([m,...o])),c=u}if(!c)return;w(),C("/orders/".concat(c))}catch(d){P("Failed to place order. Please try again."),K("Failed to place order. Please try again.",{type:"error"})}finally{M(!1),D(!0);try{globalThis.__RECONCILE_PAUSED=!1}catch(o){}}},className:"bg-white rounded-lg shadow p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone Number"}),e.jsx("input",{id:"phone",name:"phone",type:"tel",value:B.phone,onChange:e=>Q(t=>({...t,phone:e.target.value.replace(/\D/g,"").slice(0,10)})),inputMode:"numeric",maxLength:10,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",placeholder:"",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"10-digit mobile number"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700 mb-1",children:"Delivery Address"}),e.jsx("textarea",{id:"address",name:"address",required:!0,value:[B.address.houseNo,B.address.area,B.address.landmark,B.address.city,B.address.state,B.address.pincode].filter(Boolean).join(", "),onChange:e=>{const{name:t,value:s}=e.target;Q(e=>({...e,[t]:s}))},rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",readOnly:!0})]}),e.jsx("button",{type:"button",onClick:()=>I(!0),className:"w-full mt-2 py-2 px-4 rounded-lg font-medium bg-blue-100 text-blue-800 hover:bg-blue-200",children:"Edit address"}),E&&e.jsx("p",{className:"text-sm text-green-700",children:"Location confirmed"}),e.jsxs("div",{className:"border-t pt-4",children:[O,e.jsxs("button",{type:"button",onClick:()=>q(!0),className:"w-full text-left text-green-700 font-medium flex items-center justify-between",children:["Apply Coupon",e.jsx("span",{className:"transition-transform ".concat(F?"rotate-180":""),children:"⌄"})]}),R&&e.jsxs("p",{className:"text-sm text-green-700 mt-2",children:["Applied ",R.code,". You save ₹",z,"."]}),U.length>0&&e.jsxs("div",{className:"mt-3 bg-amber-50 text-amber-800 rounded-lg p-3 space-y-1",children:[e.jsx("p",{className:"text-sm font-medium",children:"Removed due to stock:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm",children:[U.slice(0,3).map((t,s)=>{var a,r;return e.jsxs("li",{children:[t.name||t.productId," (",null!=(a=t.available)?a:0,"/",null!=(r=t.requested)?r:0,")"]},"".concat(t.productId,"-").concat(s))}),U.length>3&&e.jsxs("li",{children:["+",U.length-3," more…"]})]})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Payment Method"}),e.jsx("div",{className:"flex items-center space-x-2 text-gray-700",children:e.jsx("span",{className:"bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm",children:"Cash on Delivery / UPI on Delivery"})})]}),Z>0&&e.jsxs("p",{className:"text-sm text-amber-700",children:["Add ₹",Z," more to reach minimum order value."]}),e.jsx("button",{type:"submit",disabled:T||Z>0,className:"w-full py-3 rounded-lg font-semibold ".concat(T||Z>0?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"),children:T?"Placing Order...":"Place Order".concat(R?" • ₹".concat(W):"")})]}),e.jsx(h,{isOpen:_,onClose:()=>I(!1),defaultCenter:G,autoGeo:!0,showSaveCheckbox:!0,initialAddress:B.address,showMap:!1,onConfirm:async e=>{if(Q(t=>({...t,address:e.address,latitude:e.latitude,longitude:e.longitude})),V(!0),e.saveToProfile)try{await u({address:e.address,latitude:e.latitude,longitude:e.longitude}),await f(),K("Address saved to your profile",{type:"success"})}catch(t){K("Address updated for this order, but failed to save to profile",{type:"warning"})}}})]})]}),e.jsx(b,{isOpen:F,onClose:()=>q(!1),coupons:$,totalAmount:N,appliedCode:(null==R?void 0:R.code)||null,onApply:e=>{var t,s,a,r;Y({code:e.code,discountType:e.discountType,discountValue:e.discountValue,minOrderValue:null!=(t=e.minOrderValue)?t:null,maxDiscount:null!=(s=e.maxDiscount)?s:null,startsAt:null!=(a=e.startsAt)?a:null,expiresAt:null!=(r=e.expiresAt)?r:null,isActive:e.isActive})}})]})}export{j as CheckoutPage};
