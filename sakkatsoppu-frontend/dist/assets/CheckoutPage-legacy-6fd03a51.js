System.register(["./ui-vendor-legacy-1ce3db5f.js","./format-legacy-97f32d7b.js","./react-vendor-legacy-40b14165.js","./index-legacy-54a78176.js","./MapAddressModal-legacy-77e59dc0.js","./data-vendor-legacy-6b4cc34b.js","./map-vendor-legacy-febad625.js"],function(e,t){"use strict";var s,a,r,n,i,l,o,d,c,u,m,p,x,g,h,y,b,f,v;return{setters:[e=>{s=e.j,a=e.A,r=e.m},e=>{n=e.f},e=>{i=e.r,l=e.b},e=>{o=e.c,d=e.u,c=e.a,u=e.h,m=e.d,p=e.k,x=e.e,g=e.l,h=e.j,y=e.m},e=>{b=e.M},e=>{f=e.c,v=e.u},null],execute:function(){function t(e,t="start"){if(null==e)return null;if("number"==typeof e){const t=e>1e12?e:1e3*e;return Number.isFinite(t)?t:null}const s=String(e).trim();if(!s)return null;if(/^\d{10,13}$/.test(s)){const e=Number(s.length<=10?1e3*Number(s):Number(s));return Number.isFinite(e)?e:null}const a=/[T\s]\d{1,2}:\d{2}/.test(s)?s.replace(" ","T"):s+("start"===t?"T00:00:00":"T23:59:59.999"),r=new Date(a).getTime();return isNaN(r)?null:r}function j({isOpen:e,onClose:n,coupons:l,totalAmount:o,appliedCode:d,onApply:c}){const[u,m]=i.useState(""),p=Date.now(),x=i.useMemo(()=>{const e=l.map(e=>{const s=t(e.startsAt,"start"),a=t(e.expiresAt,"end"),r=(null==s||s<=p)&&(null==a||p<=a),n=null!=a&&p>a,i=null!=s&&p<s,l=!(null==(d=e.isActive)||("boolean"==typeof d?d:"number"==typeof d?0!==d:"string"!=typeof d||!/^(false|0|no|off)$/i.test(d.trim())));var d;const c=!l&&!n&&!i&&r,u=function(e,t){const s=Number(e.minOrderValue??0)||0,a=Number(t)||0;return s>0&&a<s?{eligible:!1,reason:`Add ₹${s-a} more to avail this offer`,addMore:s-a}:{eligible:!0}}(e,o),m=c&&u.eligible?function(e,t){const s=Number(t)||0,a=Number(e.discountValue)||0,r=null==e.maxDiscount?null:Number(e.maxDiscount)||0;if("amount"===e.discountType)return Math.max(0,Math.min(a,s));const n=a/100*s,i=null==r?n:Math.min(n,r);return Math.floor(i)}(e,o):0;return{c:e,active:c,elig:u,savings:m,expired:n,notStarted:i,inactive:l}}),s=e.filter(e=>e.active&&e.elig.eligible).sort((e,t)=>t.savings-e.savings);return{eligible:s,ineligible:e.filter(e=>!(e.active&&e.elig.eligible)),best:s[0]?.c.code||null}},[l,o,p]),g=({data:e})=>{const t="percentage"===e.c.discountType,a=t?"PERCENT OFF":"FLAT OFF",r=t?`Save ${e.c.discountValue}%${e.c.maxDiscount?` up to ₹${e.c.maxDiscount}`:""}`:`Get Flat ₹${e.c.discountValue} off`,i=t?`Use code ${e.c.code} & save ${e.c.discountValue}%${e.c.maxDiscount?` (max ₹${e.c.maxDiscount})`:""}${e.c.minOrderValue?` on orders above ₹${e.c.minOrderValue}`:""}`:`Use code ${e.c.code} & get ₹${e.c.discountValue} off${e.c.minOrderValue?` on orders above ₹${e.c.minOrderValue}`:""}`,l=!(e.active&&e.elig.eligible),o=x.best&&x.best===e.c.code;let u=d&&d===e.c.code?"APPLIED":"APPLY";return l&&(e.expired?u="EXPIRED":e.notStarted?u="SOON":e.inactive&&(u="UNAVAILABLE")),s.jsxs("div",{className:`relative overflow-hidden rounded-xl border ${l?"border-gray-200 opacity-70":"border-green-200"} bg-white`,children:[s.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-14 bg-gray-100 flex flex-col items-center justify-center text-[10px] tracking-wider text-gray-600",children:s.jsx("div",{className:"rotate-[-90deg] whitespace-nowrap",children:a})}),s.jsxs("div",{className:"pl-16 p-4",children:[s.jsxs("div",{className:"flex items-start justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-extrabold tracking-wide",children:e.c.code}),!e.elig.eligible&&e.elig.reason&&s.jsx("p",{className:"text-xs text-amber-700 mt-1",children:e.elig.reason}),e.elig.eligible&&s.jsxs("p",{className:"text-xs text-green-700 mt-1",children:["You save ₹",e.savings]})]}),s.jsx("button",{disabled:l,onClick:()=>{c(e.c),n()},className:"text-sm font-semibold "+(l?"text-gray-400 cursor-not-allowed":"text-green-700 hover:text-green-800"),children:u})]}),s.jsx("p",{className:"text-sm text-gray-800 mt-2",children:r}),s.jsx("div",{className:"my-2 border-t border-dashed"}),s.jsx("p",{className:"text-xs text-gray-600",children:i}),l&&e.expired&&s.jsx("p",{className:"text-xs text-red-600 mt-1",children:"Coupon expired"}),e.c.description&&s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:e.c.description}),o&&s.jsx("span",{className:"inline-block mt-2 text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full",children:"Best savings"})]})]})};return s.jsx(a,{children:e&&s.jsxs(r.div,{className:"fixed inset-0 z-50",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:[s.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:n}),s.jsxs(r.div,{className:"absolute inset-x-0 bottom-0 bg-gray-50 rounded-t-2xl shadow-2xl max-h-[85vh] overflow-auto",initial:{y:"100%"},animate:{y:0},exit:{y:"100%"},transition:{type:"spring",stiffness:260,damping:28},children:[s.jsxs("div",{className:"p-4 border-b bg-white rounded-t-2xl",children:[s.jsx("div",{className:"h-1 w-10 bg-gray-200 rounded mx-auto mb-3"}),s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-semibold",children:"Apply Coupon"}),s.jsxs("p",{className:"text-xs text-gray-500",children:["Your cart: ₹",o]})]}),s.jsx("button",{onClick:n,className:"text-sm text-gray-600 hover:text-gray-800",children:"Close"})]}),s.jsxs("div",{className:"mt-3 flex gap-2",children:[s.jsx("input",{value:u,onChange:e=>m(e.target.value.toUpperCase()),placeholder:"Enter coupon code",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"}),s.jsx("button",{onClick:()=>{const e=u.trim().toLowerCase(),t=x.eligible.find(t=>t.c.code.toLowerCase()===e);t&&(c(t.c),n())},className:"px-4 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700",children:"Apply"})]})]}),s.jsxs("div",{className:"p-4 space-y-3",children:[x.eligible.length>0&&s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-xs font-semibold text-gray-600",children:"Eligible for you"}),x.eligible.map(e=>s.jsx(g,{data:e},e.c.code))]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx("p",{className:"text-xs font-semibold text-gray-600",children:"More offers"}),0===x.ineligible.length?s.jsx("p",{className:"text-xs text-gray-500",children:"No other offers."}):x.ineligible.map(e=>s.jsx(g,{data:e},e.c.code))]})]})]})]})})}e("CheckoutPage",function(){const{user:e,isAuthenticated:t,refreshProfile:a}=o(),{items:r,totalPrice:N,clearCart:w}=d();c(r.map(e=>e.product._id));const[A,D]=i.useState(!0),{Banner:O}=u({enabled:A,mutate:!1}),C=l(),k=f(),[S,P]=i.useState(""),[T,$]=i.useState(!1),[M,E]=i.useState(!1),[V,F]=i.useState(!1),[q,_]=i.useState(!1),[I,U]=i.useState([]),{show:L}=m(),[K,R]=i.useState(null),[Y,B]=i.useState({address:e?.address||{houseNo:"",landmark:"",area:"",city:"Mysore",state:"Karnataka",pincode:""},latitude:e?.latitude||0,longitude:e?.longitude||0,phone:e?.phone||""}),Q=i.useMemo(()=>e?.latitude&&e?.longitude?{lat:e.latitude,lon:e.longitude}:Y.latitude&&Y.longitude?{lat:Y.latitude,lon:Y.longitude}:null,[e?.latitude,e?.longitude,Y.latitude,Y.longitude]),{data:G}=v({queryKey:["public","delivery-settings"],queryFn:async()=>{try{const e=(await h()).data;if(!e)throw new Error("No data");return{enabled:e.enabled??!0,deliveryFee:e.deliveryFee??0,freeDeliveryThreshold:e.freeDeliveryThreshold??0,minOrderSubtotal:e.minOrderSubtotal??0,updatedAt:e.updatedAt}}catch{return{enabled:!0,deliveryFee:0,freeDeliveryThreshold:0,minOrderSubtotal:0}}},staleTime:6e5});i.useEffect(()=>{e&&B(t=>({...t,address:e.address||{houseNo:"",landmark:"",area:"",city:"Mysore",state:"Karnataka",pincode:""},latitude:t.latitude&&0!==t.latitude?t.latitude:e.latitude||0,longitude:t.longitude&&0!==t.longitude?t.longitude:e.longitude||0,phone:e.phone||""}))},[e]),i.useEffect(()=>{0===r.length&&C("/cart",{replace:!0})},[r.length,C]);const{data:J=[]}=v({queryKey:["admin","coupons"],queryFn:async()=>{try{const e=(await y({page:1,limit:100})).data;let t=[];return Array.isArray(e)?t=e:e&&"object"==typeof e&&Array.isArray(e.data)&&(t=e.data||[]),t.map(e=>{const t=(e.code??e.couponCode??"").toString().toUpperCase();return t?{code:t,discountType:"percentage"===e.discountType||"amount"===e.discountType?e.discountType:"amount",discountValue:"number"==typeof e.discountValue?e.discountValue:0,minOrderValue:e.minOrderValue??null,maxDiscount:e.maxDiscount??null,startsAt:e.startsAt??null,expiresAt:e.expiresAt??null,isActive:e.isActive}:null}).filter(e=>!!e)}catch(e){const t=e?.response?.status;if(401===t||403===t)return[];throw e}},staleTime:3e5}),z=i.useMemo(()=>{if(!K)return 0;if("amount"===K.discountType)return Math.max(0,Math.min(K.discountValue,N));const e=K.discountValue/100*N,t=null==K.maxDiscount?e:Math.min(e,K.maxDiscount);return Math.floor(t)},[K,N]),X=Math.max(0,N-z),H=(()=>{const e=G;return e&&e.enabled?e.freeDeliveryThreshold>0&&X>=e.freeDeliveryThreshold?0:e.deliveryFee||0:0})(),W=Math.max(0,X+H),Z=(()=>{if(!G)return 0;const e=G.minOrderSubtotal||0;return Math.max(0,e-N)})();return 0===r.length?null:s.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8",children:[s.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Checkout"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Order Summary"}),s.jsxs("div",{className:"bg-white rounded-lg shadow p-6 space-y-4",children:[r.map(e=>{const t="number"==typeof e.product.g?e.product.g:0,a="number"==typeof e.product.pieces?e.product.pieces:0,r=t>0?t*e.quantity:0,i=r>0?n(r)||`${r} g`:null,l=a>0?a*e.quantity:0;return s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("div",{className:"min-w-0 pr-2",children:[s.jsx("p",{className:"font-medium truncate",children:e.product.name}),s.jsxs("p",{className:"text-sm text-gray-600",children:["Quantity: ",e.quantity]}),t>0&&s.jsxs("p",{className:"text-xs text-gray-600",children:["Each: ",n(t)||`${t} g`," • Total: ",i]}),a>0&&s.jsxs("p",{className:"text-xs text-gray-600",children:["Each: ",a," pcs • Total: ",l," pcs"]})]}),s.jsxs("p",{className:"font-medium whitespace-nowrap",children:["₹",e.product.price*e.quantity]})]},e.product._id)}),s.jsxs("div",{className:"border-t pt-4 mt-4 space-y-2",children:[s.jsxs("div",{className:"flex justify-between font-semibold",children:[s.jsx("span",{children:"Subtotal"}),s.jsxs("span",{children:["₹",N]})]}),K&&s.jsxs("div",{className:"flex justify-between text-green-700",children:[s.jsxs("span",{children:["Coupon (",K.code,")"]}),s.jsxs("span",{children:["-₹",z]})]}),s.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[s.jsx("span",{children:"Delivery Fee"}),s.jsx("span",{children:0===H?"Free":`₹${H}`})]}),s.jsxs("div",{className:"flex justify-between text-base",children:[s.jsx("span",{className:"font-semibold",children:"Payable"}),s.jsxs("span",{className:"font-bold",children:["₹",W]})]}),G&&G.enabled&&s.jsx("div",{className:"text-xs text-gray-600",children:G.freeDeliveryThreshold>0&&X<G.freeDeliveryThreshold?s.jsxs("p",{children:["Free delivery over ₹",G.freeDeliveryThreshold]}):null})]})]})]}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Delivery Details"}),S&&s.jsx("div",{className:"bg-red-100 text-red-700 p-3 rounded-lg mb-6",children:S}),s.jsxs("form",{onSubmit:async e=>{e.preventDefault();try{$(!0),P(""),D(!1);try{globalThis.__RECONCILE_PAUSED=!0}catch(s){}const e=String(Y.phone||"").replace(/\D/g,"");if(!e||e.length<10)return P("Please enter a valid phone number."),void L("Please enter a valid phone number.",{type:"warning"});if(!Y.address||[Y.address.houseNo,Y.address.area,Y.address.landmark,Y.address.city,Y.address.state,Y.address.pincode].every(e=>!e||0===e.trim().length))return P("Please enter your delivery address."),void L("Please enter your delivery address.",{type:"warning"});if(G?.enabled&&Z>0)return P(`Add ₹${Z} more to reach minimum order value.`),void L(`Add ₹${Z} more to reach minimum order value.`,{type:"warning"});let n;if(!t)return P("Please log in to place an order."),void C("/login");try{const e=[];if(await Promise.all(r.map(async t=>{try{const s=(await x(t.product._id)).data,a=Math.max(0,Number(s?.stock??t.product.stock??0)),r=t.quantity;(a<=0&&r>0||r>a)&&e.push({productId:t.product._id,requested:r,available:a,name:s?.name||t.product.name})}catch{}})),e.length>0){if(U(e),e.every(e=>e.available<=0)&&e.length===r.length)return P("All items appear out of stock. Please review your cart."),void L("All items appear out of stock. Please review your cart.",{type:"error"});L(`${e.length} item(s) may be reduced due to stock.`,{type:"warning"})}}catch{}try{const t=(await g({...Y,phone:e,paymentMode:"COD",idempotencyKey:globalThis.crypto?.randomUUID?.()||`${Date.now()}_${Math.random()}`,couponCode:K?.code?.trim()?K.code.trim():void 0,items:r.map(e=>({productId:e.product._id,quantity:e.quantity}))})).data||{},s=t.order||t;n=s?._id||s?.id,await k.invalidateQueries({queryKey:["orders"]}),await k.refetchQueries({queryKey:["orders"],type:"active"}),Array.isArray(t.itemsOutOfStock)&&t.itemsOutOfStock.length>0?(U(t.itemsOutOfStock),L(`${t.itemsOutOfStock.length} item(s) removed due to stock.`,{type:"warning"})):L("Order placed successfully",{type:"success"})}catch(a){const t=a,s=t?.response?.status,i=t?.response?.data;if("number"==typeof s){if(400===s){const e=i?.reason;if("MIN_ORDER_NOT_MET"===e){const e=Number(i?.shortfall??0);P(`Add ₹${e} more to reach minimum order value.`),L(`Add ₹${e} more to reach minimum order value.`,{type:"warning"})}else{const e=i?.message||"Cart seems empty or invalid request.";P(e),L(e,{type:"error"})}return}return 401===s?(P("Your session expired. Please log in again."),L("Your session expired. Please log in again.",{type:"error"}),void C("/login")):404===s?(P(i?.message||"User not found. Please log in again."),L("User not found. Please log in again.",{type:"error"}),void C("/login")):409===s?(P(i?.message||"All items are out of stock."),void L("All items are out of stock.",{type:"error"})):(P(i?.message||"Error creating order. Please try again."),void L(i?.message||"Error creating order. Please try again.",{type:"error"}))}const l=localStorage.getItem("sakkat_orders"),o=l?JSON.parse(l):[],d=`local_${Date.now()}`,c={id:d,items:r.map(e=>({productId:e.product._id,quantity:e.quantity,price:e.product.price})),totalPrice:N,address:Y.address,latitude:Y.latitude,longitude:Y.longitude,phone:e,createdAt:(new Date).toISOString(),paymentMode:"COD",status:"pending"};localStorage.setItem("sakkat_orders",JSON.stringify([c,...o])),n=d}if(!n)return;w(),C(`/orders/${n}`)}catch(a){P("Failed to place order. Please try again."),L("Failed to place order. Please try again.",{type:"error"})}finally{$(!1),D(!0);try{globalThis.__RECONCILE_PAUSED=!1}catch(s){}}},className:"bg-white rounded-lg shadow p-6 space-y-6",children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone Number"}),s.jsx("input",{id:"phone",name:"phone",type:"tel",value:Y.phone,onChange:e=>B(t=>({...t,phone:e.target.value.replace(/\D/g,"").slice(0,10)})),inputMode:"numeric",maxLength:10,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",placeholder:"",required:!0}),s.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"10-digit mobile number"})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700 mb-1",children:"Delivery Address"}),s.jsx("textarea",{id:"address",name:"address",required:!0,value:[Y.address.houseNo,Y.address.area,Y.address.landmark,Y.address.city,Y.address.state,Y.address.pincode].filter(Boolean).join(", "),onChange:e=>{const{name:t,value:s}=e.target;B(e=>({...e,[t]:s}))},rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500",readOnly:!0})]}),s.jsx("button",{type:"button",onClick:()=>_(!0),className:"w-full mt-2 py-2 px-4 rounded-lg font-medium bg-blue-100 text-blue-800 hover:bg-blue-200",children:"Set address on map"}),M&&s.jsx("p",{className:"text-sm text-green-700",children:"Location confirmed"}),s.jsxs("div",{className:"border-t pt-4",children:[O,s.jsxs("button",{type:"button",onClick:()=>F(!0),className:"w-full text-left text-green-700 font-medium flex items-center justify-between",children:["Apply Coupon",s.jsx("span",{className:"transition-transform "+(V?"rotate-180":""),children:"⌄"})]}),K&&s.jsxs("p",{className:"text-sm text-green-700 mt-2",children:["Applied ",K.code,". You save ₹",z,"."]}),I.length>0&&s.jsxs("div",{className:"mt-3 bg-amber-50 text-amber-800 rounded-lg p-3 space-y-1",children:[s.jsx("p",{className:"text-sm font-medium",children:"Removed due to stock:"}),s.jsxs("ul",{className:"list-disc list-inside text-sm",children:[I.slice(0,3).map((e,t)=>s.jsxs("li",{children:[e.name||e.productId," (",e.available??0,"/",e.requested??0,")"]},`${e.productId}-${t}`)),I.length>3&&s.jsxs("li",{children:["+",I.length-3," more…"]})]})]})]}),s.jsxs("div",{className:"border-t pt-6",children:[s.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Payment Method"}),s.jsx("div",{className:"flex items-center space-x-2 text-gray-700",children:s.jsx("span",{className:"bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm",children:"Cash on Delivery / UPI on Delivery"})})]}),Z>0&&s.jsxs("p",{className:"text-sm text-amber-700",children:["Add ₹",Z," more to reach minimum order value."]}),s.jsx("button",{type:"submit",disabled:T||Z>0,className:"w-full py-3 rounded-lg font-semibold "+(T||Z>0?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-green-600 hover:bg-green-700 text-white"),children:T?"Placing Order...":"Place Order"+(K?` • ₹${W}`:"")})]}),s.jsx(b,{isOpen:q,onClose:()=>_(!1),defaultCenter:Q,autoGeo:!0,showSaveCheckbox:!0,initialAddress:Y.address,onConfirm:async e=>{if(B(t=>({...t,address:e.address,latitude:e.latitude,longitude:e.longitude})),E(!0),e.saveToProfile)try{await p({address:e.address,latitude:e.latitude,longitude:e.longitude}),await a(),L("Address saved to your profile",{type:"success"})}catch(t){L("Address updated for this order, but failed to save to profile",{type:"warning"})}}})]})]}),s.jsx(j,{isOpen:V,onClose:()=>F(!1),coupons:J,totalAmount:N,appliedCode:K?.code||null,onApply:e=>{R({code:e.code,discountType:e.discountType,discountValue:e.discountValue,minOrderValue:e.minOrderValue??null,maxDiscount:e.maxDiscount??null,startsAt:e.startsAt??null,expiresAt:e.expiresAt??null,isActive:e.isActive})}})]})})}}});
